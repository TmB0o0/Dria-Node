#!/bin/bash

# ะะฟัะตะดะตะปะธะผ ัะฒะตัะฐ ะดะปั ัะตะบััะฐ
WHITE="\033[1;37m"
RESET="\033[0m"

# ะะพะณะพัะธะฟ
logo() {
    echo "  ##  ###  #######  ######   #######  #######  #######  ######   #######  ##  ##   #######  ###### "
    echo "  ### ###  ##   ##  ##  ##   ##       ##         ###    ##  ##     ###    ##  ##   ##       ##  ## "
    echo "  #######  ##   ##  ##  ##   ##       #######    ###    ##  ##     ###    ## ##    ##       ##  ## "
    echo "  ## ####  ##  ###  ### ###  #######       ##    ###    #######    ###    #######  #######  ####### "
    echo "  ##  ###  ##  ###  ### ###  ###      ###  ##    ###    ### ###    ###    ##  ###  ###      ### ### "
    echo "  ##  ###  ##  ###  ### ###  # #      ###  ##    ###    ### ###    ###    ##  ###  # #      ### ### "
    echo "  ##  ###  #######  #######  #######  #######    ###    ### ###  #######  ##  ###  #######  ### ### "
}

# ะคัะฝะบัะธั ะดะปั ัััะฐะฝะพะฒะบะธ ะฝะพะดั
install_node() {
    echo "ะะฐะฟััะบ ัััะฐะฝะพะฒะบะธ ะฝะพะดั... ๐ฑ"

    # ะะฑะฝะพะฒะปะตะฝะธะต ัะธััะตะผั ะธ ัััะฐะฝะพะฒะบะฐ ะฝะตะพะฑัะพะดะธะผัั ะฟะฐะบะตัะพะฒ
    sudo apt update && sudo apt install -y curl git make jq build-essential gcc unzip wget lz4 aria2 tmux

    # ะฃััะฐะฝะพะฒะบะฐ Dria Launcher (ะฟัะพะฒะตัะบะฐ ะฝะฐ ะฝะฐะปะธัะธะต)
    if [ ! -f "/usr/local/bin/dria-launcher" ]; then
        echo "ะกะบะฐัะธะฒะฐั ะธ ัััะฐะฝะฐะฒะปะธะฒะฐั Dria Launcher... ๐"
        curl -fsSL https://dria.co/launcher | bash
    else
        echo "Dria Launcher ัะถะต ัััะฐะฝะพะฒะปะตะฝ. โ"
    fi

    # ะฃััะฐะฝะพะฒะบะฐ Ollama (ะฟัะพะฒะตัะบะฐ ะฝะฐ ะฝะฐะปะธัะธะต)
    if [ ! -f "/usr/local/bin/ollama" ]; then
        echo "ะกะบะฐัะธะฒะฐั ะธ ัััะฐะฝะฐะฒะปะธะฒะฐั Ollama... ๐ป"
        curl -fsSL https://ollama.com/install.sh | sh
    else
        echo "Ollama ัะถะต ัััะฐะฝะพะฒะปะตะฝ. โ"
    fi

    # ะะฐะฟััะบ tmux ั ะบะพะผะฐะฝะดะพะน ะดะปั ััะฐััะฐ ะฝะพะดั
    echo "ะะฐะฟััะบ tmux ั ะบะพะผะฐะฝะดะพะน ะดะปั ััะฐััะฐ ะฝะพะดั... ๐ฅ๏ธ"

    # ะัะพะฒะตััะตะผ, ะตััั ะปะธ ัะถะต tmux-ัะตััะธั ั ะธะผะตะฝะตะผ 'dria_node'
    tmux has-session -t dria_node 2>/dev/null

    if [ $? != 0 ]; then
        # ะัะปะธ ัะตััะธั ะฝะต ัััะตััะฒัะตั, ัะพะทะดะฐะตะผ ะฝะพะฒัั ัะตััะธั ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะผะฐะฝะดั
        tmux new-session -d -s dria_node 'dkn-compute-launcher start'
        echo "ะะพะดะฐ ััะฟะตัะฝะพ ะทะฐะฟััะตะฝะฐ ะฒ ะฝะพะฒะพะน tmux ัะตััะธะธ. ๐"
        tmux attach -t dria_node  # ะะพะดะบะปััะฐะตะผัั ะบ ะฝะพะฒะพะน ัะตััะธะธ
    else
        # ะัะปะธ ัะตััะธั ัััะตััะฒัะตั, ะฟัะพััะพ ะฟัะธัะพะตะดะธะฝัะตะผัั ะบ ะฝะตะน
        echo "ะกะตััะธั tmux ั ะธะผะตะฝะตะผ 'dria_node' ัะถะต ัััะตััะฒัะตั. ะัะธัะพะตะดะธะฝัััั... ๐"
        tmux attach -t dria_node
    fi
}

# ะคัะฝะบัะธั ะดะปั ะธะทะผะตะฝะตะฝะธั ะฝะฐัััะพะตะบ
change_settings() {
    echo "ะะฐะฟััะบ ะธะทะผะตะฝะตะฝะธั ะฝะฐัััะพะตะบ... โ๏ธ"
    dkn-compute-launcher settings
}

# ะคัะฝะบัะธั ะดะปั ัะฐะฑะพัั ั $DRIA Points
check_points() {
    echo "ะะฐะฟััะบ ะฟัะพะฒะตัะบะธ $DRIA Points... ๐ฐ"
    dkn-compute-launcher points
}

# ะคัะฝะบัะธั ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะฒัััะฝัั
update_manually() {
    echo "ะะฐะฟััะบ ะพะฑะฝะพะฒะปะตะฝะธั ะฒัััะฝัั... ๐"
    dkn-compute-launcher update
}

# ะคัะฝะบัะธั ะดะปั ัะดะฐะปะตะฝะธั
uninstall_node() {
    echo "ะะฐะฟััะบ ัะดะฐะปะตะฝะธั ะฝะพะดั... ๐๏ธ"
    dkn-compute-launcher uninstall
}

# ะคัะฝะบัะธั ะดะปั ะพัะพะฑัะฐะถะตะฝะธั ะผะตะฝั
show_menu() {
    # ะัะพะฒะตัะบะฐ ะฝะฐ ัััะตััะฒะพะฒะฐะฝะธะต tmux-ัะตััะธะธ
    tmux has-session -t dria_menu 2>/dev/null
    if [ $? != 0 ]; then
        # ะัะปะธ ัะตััะธั ะฝะต ัััะตััะฒัะตั, ัะพะทะดะฐะตะผ ะฝะพะฒัั ัะตััะธั ะดะปั ะผะตะฝั
        tmux new-session -d -s dria_menu
    fi

    clear
    logo  # ะัะฒะพะดะธะผ ะปะพะณะพัะธะฟ

    # ะะบะฝะพ ั ัะตะบััะพะผ ะผะตะฝั
    echo -e "\n${WHITE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${RESET}"
    echo -e "${WHITE}โ        MANAGEMENT MENU        โ${RESET}"
    echo -e "${WHITE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${RESET}\n"

    echo "====================================="
    echo "ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:"
    echo "1. ะฃััะฐะฝะพะฒะธัั ะฝะพะดั ๐ฑ"
    echo "2. ะะทะผะตะฝะธัั ะฝะฐัััะพะนะบะธ โ๏ธ"
    echo "3. ะัะพะฒะตัะธัั $DRIA Points ๐ฐ"
    echo "4. ะะฑะฝะพะฒะธัั ะฒัััะฝัั ๐"
    echo "5. ะฃะดะฐะปะธัั ะฝะพะดั ๐๏ธ"
    echo "6. ะัะนัะธ ๐ช"
    echo "====================================="
    read -p "ะัะฑะตัะธัะต ะฟัะฝะบั [1-6]: " choice
    case $choice in
        1) install_node ;;
        2) change_settings ;;
        3) check_points ;;
        4) update_manually ;;
        5) uninstall_node ;;
        6) tmux kill-session -t dria_menu; exit 0 ;;
        *) echo "ะะตะฒะตัะฝัะน ะฒัะฑะพั, ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ. โ"; sleep 2; show_menu ;;
    esac
}

# ะะฐะฟััะบ ะผะตะฝั ะฒ tmux ัะตััะธะธ
tmux attach -t dria_menu || show_menu
